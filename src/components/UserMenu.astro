---
interface Props {
  email: string;
}

const { email } = Astro.props;
const initial = email.charAt(0).toUpperCase();
---

<div class="relative" id="user-menu">
  <button
    type="button"
    id="user-menu-button"
    class="flex items-center gap-2 text-content-secondary hover:text-content-primary transition-colors p-1 -m-1"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <div class="w-8 h-8 bg-brand rounded-full flex items-center justify-center text-sm font-medium text-white">
      {initial}
    </div>
    <span class="hidden sm:inline text-sm">{email}</span>
    <svg class="w-4 h-4 transition-transform hidden sm:block" id="menu-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <!-- Dropdown menu -->
  <div
    id="user-dropdown"
    class="absolute right-0 mt-2 w-48 bg-surface-card rounded-xl shadow-lg border border-border-default py-1 hidden z-50"
    role="menu"
    aria-orientation="vertical"
    aria-labelledby="user-menu-button"
  >
    <a
      href="/profile"
      class="flex items-center gap-2 px-4 py-3 text-sm text-content-secondary hover:bg-surface-hover hover:text-content-primary transition-colors"
      role="menuitem"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>
      Profile
    </a>
    <hr class="my-1 border-border-default" />
    <form method="POST" action="/api/auth/signout" class="w-full">
      <button
        type="submit"
        class="flex items-center gap-2 w-full px-4 py-3 text-sm text-error hover:bg-surface-hover transition-colors"
        role="menuitem"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
        Sign out
      </button>
    </form>
  </div>
</div>

<script>
  const menuButton = document.getElementById('user-menu-button');
  const dropdown = document.getElementById('user-dropdown');
  const chevron = document.getElementById('menu-chevron');

  if (menuButton && dropdown && chevron) {
    // Toggle dropdown
    menuButton.addEventListener('click', (e) => {
      e.stopPropagation();
      const isHidden = dropdown.classList.contains('hidden');
      dropdown.classList.toggle('hidden');
      chevron.classList.toggle('rotate-180');
      menuButton.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
    });

    // Close on click outside
    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target as Node) && !menuButton.contains(e.target as Node)) {
        dropdown.classList.add('hidden');
        chevron.classList.remove('rotate-180');
        menuButton.setAttribute('aria-expanded', 'false');
      }
    });

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        dropdown.classList.add('hidden');
        chevron.classList.remove('rotate-180');
        menuButton.setAttribute('aria-expanded', 'false');
      }
    });
  }
</script>
