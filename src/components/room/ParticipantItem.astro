---
import type { Participant, VotingStatus } from '../../lib/room/types';
import { getAvatarUrl } from '../../lib/room/types';

interface Props {
  participant: Participant;
  isCurrentUser: boolean;
  votingStatus: VotingStatus;
  canPromote?: boolean;
  canDemote?: boolean;
  canKick?: boolean;
  isOnline?: boolean;
  isViewerManager?: boolean;
  showVotes?: boolean;
}

const { participant, isCurrentUser, votingStatus, canPromote = false, canDemote = false, canKick = false, isOnline = true, isViewerManager = false, showVotes = false } = Astro.props;

const initial = participant.name.charAt(0).toUpperCase();
const hasVoted = !!participant.current_vote;
// Managers can see votes during voting, everyone sees after reveal
const showVoteValue = (isViewerManager || votingStatus === 'revealed') && participant.current_vote;
// Hide vote indicator if not manager and showVotes is disabled
const hideVoteIndicator = !isViewerManager && !showVotes;

// Avatar URL - use DiceBear if avatar fields exist, otherwise fallback to name as seed
const avatarStyle = participant.avatar_style || 'adventurer';
const avatarSeed = participant.avatar_seed || participant.name;
const avatarUrl = getAvatarUrl(avatarStyle, avatarSeed, 32);
---

<li
  class:list={[
    "flex items-center gap-3 p-2 rounded-lg hover:bg-slate-800/50",
    !isOnline && "opacity-50"
  ]}
  data-participant-id={participant.id}
  data-participant-role={participant.role}
  data-is-online={isOnline ? 'true' : 'false'}
>
  <div class="relative flex-shrink-0">
    <img
      src={avatarUrl}
      alt={participant.name}
      class:list={[
        "w-8 h-8 rounded-full participant-avatar",
        !isOnline && "grayscale opacity-70"
      ]}
      data-avatar-style={avatarStyle}
      data-avatar-seed={avatarSeed}
      loading="lazy"
    />
    <!-- Current user indicator (star) -->
    {isCurrentUser && (
      <div class="absolute -top-1 -left-1 w-4 h-4 bg-amber-500 rounded-full border-2 border-slate-900 flex items-center justify-center current-user-indicator">
        <svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
        </svg>
      </div>
    )}
    <!-- Online status indicator -->
    <div
      class:list={[
        'absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-slate-900 flex items-center justify-center online-indicator',
        isOnline ? 'bg-green-500' : 'bg-slate-700'
      ]}
      data-is-online={isOnline ? 'true' : 'false'}
    >
      {isOnline ? (
        <!-- Green dot (empty, the bg color shows) -->
        <span></span>
      ) : (
        <!-- Disconnect icon -->
        <svg class="w-2.5 h-2.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M18.364 5.636a9 9 0 11-12.728 0M12 9v4" />
        </svg>
      )}
    </div>
  </div>

  <div class="flex-1 min-w-0">
    <span class="text-white text-sm truncate block participant-name">{participant.name}</span>
    {participant.role === 'manager' && (
      <span class="text-xs text-indigo-400">Manager</span>
    )}
  </div>

  <!-- Vote indicator column (aligned) -->
  <div
    class:list={[
      "vote-indicator w-7 h-7 rounded flex items-center justify-center text-xs font-bold flex-shrink-0",
      showVoteValue ? "bg-indigo-600/30 text-indigo-300" :
        hasVoted ? "bg-green-600/30 text-green-400" : "bg-slate-700/50 text-slate-500",
      hideVoteIndicator && "hidden"
    ]}
    data-has-vote={hasVoted ? 'true' : 'false'}
    data-vote={participant.current_vote || ''}
  >
    {showVoteValue ? (
      <span class="vote-value">{participant.current_vote}</span>
    ) : hasVoted ? (
      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
      </svg>
    ) : (
      <span>-</span>
    )}
  </div>

  <!-- Promote/Demote column (fixed width) -->
  <div class="w-6 flex items-center justify-center flex-shrink-0 promote-demote-slot">
    {canPromote && (
      <button
        class="promote-btn p-1 text-slate-400 hover:text-indigo-400 transition-colors"
        title="Make manager"
        data-participant-id={participant.id}
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
        </svg>
      </button>
    )}
    {canDemote && (
      <button
        class="demote-btn p-1 text-slate-400 hover:text-red-400 transition-colors"
        title={isCurrentUser ? "Step down as manager" : "Remove manager"}
        data-participant-id={participant.id}
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
    )}
  </div>

  <!-- Kick column (fixed width) -->
  <div class="w-6 flex items-center justify-center flex-shrink-0 kick-slot">
    {canKick && (
      <button
        class="kick-btn p-1 text-slate-400 hover:text-red-400 transition-colors"
        title="Remove from room"
        data-participant-id={participant.id}
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    )}
  </div>
</li>
