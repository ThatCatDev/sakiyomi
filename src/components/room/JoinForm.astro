---
import { getAvatarUrl } from '../../lib/room/types';

interface Props {
  roomId: string;
}

const { roomId } = Astro.props;

// Generate random initial avatar
const funStyles = [
  'adventurer',
  'big-smile',
  'bottts',
  'fun-emoji',
  'lorelei',
  'micah',
  'notionists',
  'pixel-art',
  'thumbs',
  'avataaars',
];
const randomStyle = funStyles[Math.floor(Math.random() * funStyles.length)];
const randomSeed = `join-${Date.now()}`;
const initialAvatarUrl = getAvatarUrl(randomStyle, randomSeed, 80);
---

<div class="max-w-md mx-auto mt-20">
  <div class="bg-surface-card rounded-2xl p-8 border border-border-default" id="join-section">
    <h2 class="text-2xl font-semibold text-content-primary mb-2 text-center">Join this room</h2>
    <p class="text-content-muted text-center mb-6">Pick your avatar and enter your name</p>

    <form action={`/api/rooms/${roomId}/join`} method="POST" id="join-form" class="space-y-6">
      <!-- Avatar Selection -->
      <div class="flex flex-col items-center gap-3">
        <div class="relative group">
          <img
            id="join-avatar-preview"
            src={initialAvatarUrl}
            alt="Your avatar"
            class="w-24 h-24 rounded-full bg-surface-tertiary cursor-pointer transition-transform hover:scale-105"
          />
          <button
            type="button"
            id="randomize-join-avatar"
            class="absolute -bottom-1 -right-1 w-8 h-8 bg-brand hover:bg-brand-hover rounded-full flex items-center justify-center text-white transition-colors shadow-lg"
            title="Randomize avatar"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
          </button>
        </div>
        <p class="text-content-muted text-xs">Click to randomize</p>
      </div>

      <!-- Hidden avatar fields -->
      <input type="hidden" name="avatar_style" id="join-avatar-style" value={randomStyle} />
      <input type="hidden" name="avatar_seed" id="join-avatar-seed" value={randomSeed} />

      <!-- Name input -->
      <input
        type="text"
        name="name"
        id="name"
        required
        placeholder="Your name"
        class="w-full px-4 py-3 bg-surface-primary border border-border-default rounded-xl text-content-primary placeholder-content-muted focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent text-center text-lg"
      />

      <button
        type="submit"
        class="w-full px-4 py-3 bg-brand hover:bg-brand-hover text-white font-medium rounded-xl transition-colors"
      >
        Join Room
      </button>
      <p id="join-error" class="text-red-400 text-sm text-center hidden"></p>
    </form>
  </div>
</div>

<script>
  const funStyles = [
    'adventurer',
    'big-smile',
    'bottts',
    'fun-emoji',
    'lorelei',
    'micah',
    'notionists',
    'pixel-art',
    'thumbs',
    'avataaars',
    'big-ears',
    'croodles',
    'open-peeps',
    'personas',
    'miniavs',
    'shapes',
  ];

  function getAvatarUrl(style: string, seed: string, size = 80): string {
    return `https://api.dicebear.com/7.x/${style}/svg?seed=${encodeURIComponent(seed)}&size=${size}`;
  }

  function randomizeAvatar() {
    const randomStyle = funStyles[Math.floor(Math.random() * funStyles.length)];
    const randomSeed = `join-${Date.now()}-${Math.random().toString(36).slice(2)}`;

    const preview = document.getElementById('join-avatar-preview') as HTMLImageElement;
    const styleInput = document.getElementById('join-avatar-style') as HTMLInputElement;
    const seedInput = document.getElementById('join-avatar-seed') as HTMLInputElement;

    if (preview && styleInput && seedInput) {
      preview.src = getAvatarUrl(randomStyle, randomSeed, 80);
      styleInput.value = randomStyle;
      seedInput.value = randomSeed;
    }
  }

  // Randomize on button click
  document.getElementById('randomize-join-avatar')?.addEventListener('click', (e) => {
    e.preventDefault();
    randomizeAvatar();
  });

  // Also randomize when clicking the avatar itself
  document.getElementById('join-avatar-preview')?.addEventListener('click', () => {
    randomizeAvatar();
  });

  // Handle form submit with loading state
  const joinForm = document.getElementById('join-form') as HTMLFormElement;
  const joinButton = joinForm?.querySelector('button[type="submit"]') as HTMLButtonElement;
  const joinError = document.getElementById('join-error');

  const spinnerSvg = `<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
  </svg>`;

  joinForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const originalText = joinButton.innerHTML;
    joinButton.innerHTML = spinnerSvg;
    joinButton.disabled = true;
    joinError?.classList.add('hidden');

    try {
      const formData = new FormData(joinForm);
      const response = await fetch(joinForm.action, {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (!response.ok) {
        if (joinError) {
          joinError.textContent = result.error || 'Failed to join room';
          joinError.classList.remove('hidden');
        }
        joinButton.innerHTML = originalText;
        joinButton.disabled = false;
        return;
      }

      window.location.reload();
    } catch {
      if (joinError) {
        joinError.textContent = 'Failed to join room. Please try again.';
        joinError.classList.remove('hidden');
      }
      joinButton.innerHTML = originalText;
      joinButton.disabled = false;
    }
  });
</script>
