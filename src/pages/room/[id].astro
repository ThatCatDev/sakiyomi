---
import Layout from '../../layouts/Layout.astro';
import UserMenu from '../../components/UserMenu.astro';
import { createSupabaseServerClient } from '../../lib/supabase';

// Room components
import JoinForm from '../../components/room/JoinForm.astro';
import VotingCards from '../../components/room/VotingCards.astro';
import ManagerControls from '../../components/room/ManagerControls.astro';
import StatusBanner from '../../components/room/StatusBanner.astro';
import ParticipantsSidebar from '../../components/room/ParticipantsSidebar.astro';
import VoteResults from '../../components/room/VoteResults.astro';
import LeaveModal from '../../components/room/LeaveModal.astro';

import type { Participant, VotingStatus } from '../../lib/room/types';

const { id } = Astro.params;

const cookieHeader = Astro.request.headers.get('Cookie') ?? '';
const supabase = createSupabaseServerClient(Astro.cookies, cookieHeader);
const { data: { user } } = await supabase.auth.getUser();

// Fetch room
const { data: room, error } = await supabase
  .from('rooms')
  .select('*')
  .eq('id', id)
  .single();

if (error || !room) {
  return Astro.redirect('/404');
}

// Check if user has joined this room
const sessionId = Astro.cookies.get('session_id')?.value;
let currentParticipant: Participant | null = null;

if (sessionId) {
  const { data } = await supabase
    .from('room_participants')
    .select('*')
    .eq('room_id', id)
    .eq('session_id', sessionId)
    .single();
  currentParticipant = data as Participant | null;
}

// Fetch all participants (initial load)
const { data: participantsData } = await supabase
  .from('room_participants')
  .select('*')
  .eq('room_id', id)
  .order('created_at', { ascending: true });

const participants = (participantsData || []) as Participant[];
const roomUrl = `${Astro.url.origin}/room/${room.id}`;

// Pass data to client
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

const isManager = currentParticipant?.role === 'manager';
const votingStatus = (room.voting_status || 'waiting') as VotingStatus;
const currentTopic = room.current_topic || '';
const showVotes = room.show_votes ?? false;
---

<Layout title={`${room.name} - Story Poker`}>
  <main class="min-h-screen flex flex-col">
    <!-- Navigation -->
    <nav class="border-b border-slate-800 flex-shrink-0">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="/" class="flex items-center gap-2">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
            <span class="text-lg font-bold text-white hidden sm:inline">Story Poker</span>
          </a>
          <span class="text-slate-500">|</span>
          <h1 class="text-white font-medium truncate max-w-[200px] sm:max-w-none">{room.name}</h1>
        </div>

        <div class="flex items-center gap-3">
          <!-- Share Link -->
          <div class="hidden md:flex items-center gap-2 bg-slate-800 rounded-lg px-3 py-1.5 border border-slate-700">
            <input
              type="text"
              readonly
              value={roomUrl}
              id="room-url"
              class="w-48 bg-transparent text-white text-sm focus:outline-none"
            />
            <button
              id="copy-btn"
              class="text-slate-400 hover:text-white transition-colors"
              title="Copy link"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="copy-icon">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              <svg class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="check-icon">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </button>
          </div>

          {user ? (
            <UserMenu email={user.email || ''} />
          ) : (
            <a href="/login" class="text-slate-300 hover:text-white transition-colors text-sm">
              Sign in
            </a>
          )}
        </div>
      </div>
    </nav>

    <!-- Main Content with Sidebar -->
    <div class="flex-1 flex overflow-hidden">
      <!-- Center: Voting Area -->
      <div class="flex-1 p-6 overflow-y-auto">
        {!currentParticipant ? (
          <JoinForm roomId={id!} />
        ) : (
          <!-- Voting Interface -->
          <div class="max-w-2xl mx-auto">
            <!-- Topic Display -->
            <div class="text-center mb-6" id="topic-section">
              <p class="text-slate-400 text-sm mb-1" id="topic-label" class:list={[{ 'hidden': !currentTopic }]}>Current topic</p>
              <h2 class="text-2xl font-semibold text-white" id="current-topic-display">{currentTopic || 'No topic set'}</h2>
            </div>

            <!-- Manager Controls -->
            {isManager && <ManagerControls votingStatus={votingStatus} showVotes={showVotes} />}

            <!-- Status Banner -->
            <StatusBanner votingStatus={votingStatus} />

            <!-- Story Point Cards -->
            <VotingCards currentVote={currentParticipant?.current_vote} votingStatus={votingStatus} />

            <!-- Your Vote Display -->
            <div class="text-center mb-8" id="your-vote-section">
              <p class="text-slate-400 text-sm mb-2">Your vote</p>
              <div class="inline-flex items-center justify-center w-16 h-20 bg-slate-800 border-2 border-slate-600 rounded-xl">
                <span class="text-2xl font-bold text-white" id="your-vote-display">{currentParticipant?.current_vote || '-'}</span>
              </div>
            </div>

            <!-- Results Section -->
            <VoteResults votingStatus={votingStatus} />
          </div>
        )}
      </div>

      <!-- Right Sidebar: Participants -->
      <ParticipantsSidebar
        currentParticipant={currentParticipant}
        participants={participants}
        votingStatus={votingStatus}
        isManager={isManager}
      />
    </div>
  </main>

  <!-- Leave Room Modal -->
  <LeaveModal />
</Layout>

<!-- Hidden data for client-side JS -->
<script id="room-data" type="application/json" set:html={JSON.stringify({
  roomId: room.id,
  currentParticipantId: currentParticipant?.id || null,
  isManager,
  votingStatus,
  currentTopic,
  showVotes,
  currentVote: currentParticipant?.current_vote || null,
  supabaseUrl,
  supabaseAnonKey,
})} />

<script>
  import { RoomBloc, RoomController } from '../../lib/room';

  // Get room data from embedded JSON
  const roomDataEl = document.getElementById('room-data');
  const roomData = roomDataEl ? JSON.parse(roomDataEl.textContent || '{}') : {};

  // Only initialize if we have a participant (user has joined)
  if (roomData.currentParticipantId) {
    // Create BLoC with initial state
    const bloc = new RoomBloc(
      roomData.supabaseUrl,
      roomData.supabaseAnonKey,
      {
        roomId: roomData.roomId,
        votingStatus: roomData.votingStatus,
        currentTopic: roomData.currentTopic,
        isManager: roomData.isManager,
        currentParticipantId: roomData.currentParticipantId,
        showVotes: roomData.showVotes,
        currentVote: roomData.currentVote,
      }
    );

    // Create controller and initialize
    const controller = new RoomController(bloc);
    controller.init();
  } else {
    // Handle join form for users who haven't joined yet
    const joinForm = document.getElementById('join-form') as HTMLFormElement;
    const joinError = document.getElementById('join-error');

    joinForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(joinForm);

      try {
        const response = await fetch(joinForm.action, {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (!response.ok) {
          if (joinError) {
            joinError.textContent = result.error || 'Failed to join room';
            joinError.classList.remove('hidden');
          }
          return;
        }

        window.location.reload();
      } catch {
        if (joinError) {
          joinError.textContent = 'Failed to join room. Please try again.';
          joinError.classList.remove('hidden');
        }
      }
    });

    // Copy functionality (for non-joined users too)
    const copyBtn = document.getElementById('copy-btn');
    const roomUrlInput = document.getElementById('room-url') as HTMLInputElement;
    const copyIcon = document.getElementById('copy-icon');
    const checkIcon = document.getElementById('check-icon');

    copyBtn?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(roomUrlInput.value);
        copyIcon?.classList.add('hidden');
        checkIcon?.classList.remove('hidden');
        setTimeout(() => {
          copyIcon?.classList.remove('hidden');
          checkIcon?.classList.add('hidden');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });
  }
</script>
