---
import type { Team, TeamRole } from '../../lib/team/types';

interface Props {
  team: Team;
  userRole: TeamRole;
}

const { team, userRole } = Astro.props;
const isOwner = userRole === 'owner';
---

<div class="space-y-6" data-team-slug={team.slug}>
  <!-- General Settings -->
  <div class="bg-surface-elevated rounded-xl p-6">
    <h3 class="text-lg font-semibold text-content-primary mb-4">General Settings</h3>

    <form id="team-settings-form" class="space-y-4">
      <div>
        <label for="settings-team-name" class="block text-sm font-medium text-content-secondary mb-1.5">
          Team Name
        </label>
        <input
          type="text"
          id="settings-team-name"
          name="name"
          value={team.name}
          required
          minlength="2"
          maxlength="50"
          class="w-full px-4 py-2.5 bg-surface-card border border-border-default rounded-xl text-content-primary focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
        />
      </div>

      <div>
        <label for="settings-avatar-url" class="block text-sm font-medium text-content-secondary mb-1.5">
          Avatar URL
        </label>
        <input
          type="url"
          id="settings-avatar-url"
          name="avatar_url"
          value={team.avatar_url || ''}
          placeholder="https://example.com/avatar.png"
          class="w-full px-4 py-2.5 bg-surface-card border border-border-default rounded-xl text-content-primary placeholder-content-muted focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
        />
        <p class="text-xs text-content-muted mt-1">
          Optional. Provide a URL to an image for your team avatar.
        </p>
      </div>

      <div id="settings-error" class="hidden text-sm text-status-error bg-status-error/10 px-4 py-2 rounded-lg">
      </div>

      <div id="settings-success" class="hidden text-sm text-status-success bg-status-success/10 px-4 py-2 rounded-lg">
        Settings saved successfully!
      </div>

      <button
        type="submit"
        class="px-6 py-2.5 bg-brand text-white rounded-xl font-medium hover:bg-brand-hover transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Save Changes
      </button>
    </form>
  </div>

  <!-- Danger Zone (Owner Only) -->
  {isOwner && (
    <div class="bg-surface-elevated rounded-xl p-6 border border-status-error/30">
      <h3 class="text-lg font-semibold text-status-error mb-4">Danger Zone</h3>

      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="font-medium text-content-primary">Delete Team</p>
            <p class="text-sm text-content-muted">
              Permanently delete this team and all its rooms. This action cannot be undone.
            </p>
          </div>
          <button
            type="button"
            onclick="openDeleteTeamModal?.()"
            class="px-4 py-2 bg-status-error text-white rounded-xl font-medium hover:bg-status-error/90 transition-colors"
          >
            Delete Team
          </button>
        </div>
      </div>
    </div>
  )}
</div>

<script>
  import { updateTeam } from '../../lib/team/api';

  function initTeamSettings() {
    const form = document.getElementById('team-settings-form') as HTMLFormElement;
    if (!form) return;

    const container = form.closest('[data-team-slug]') as HTMLElement;
    const teamSlug = container?.dataset.teamSlug;
    if (!teamSlug) return;

    const nameInput = document.getElementById('settings-team-name') as HTMLInputElement;
    const avatarInput = document.getElementById('settings-avatar-url') as HTMLInputElement;
    const errorDiv = document.getElementById('settings-error');
    const successDiv = document.getElementById('settings-success');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';
      errorDiv?.classList.add('hidden');
      successDiv?.classList.add('hidden');

      try {
        await updateTeam(teamSlug, {
          name: nameInput.value.trim(),
          avatar_url: avatarInput.value.trim() || null,
        });

        successDiv?.classList.remove('hidden');

        // Hide success message after 3 seconds
        setTimeout(() => {
          successDiv?.classList.add('hidden');
        }, 3000);
      } catch (err) {
        if (errorDiv) {
          errorDiv.textContent = err instanceof Error ? err.message : 'Failed to save settings';
          errorDiv.classList.remove('hidden');
        }
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save Changes';
      }
    });
  }

  initTeamSettings();
  document.addEventListener('astro:page-load', initTeamSettings);
</script>
