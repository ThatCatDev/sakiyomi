---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import { createSupabaseServerClient } from '../../lib/supabase';
import { getAppName } from '../../lib/branding';

// Room components
import JoinForm from '../../components/room/JoinForm.astro';
import VotingCards from '../../components/room/VotingCards.astro';
import ManagerControls from '../../components/room/ManagerControls.astro';
import StatusBanner from '../../components/room/StatusBanner.astro';
import ParticipantsSidebar from '../../components/room/ParticipantsSidebar.astro';
import VoteResults from '../../components/room/VoteResults.astro';
import LeaveModal from '../../components/room/LeaveModal.astro';
import KickConfirmModal from '../../components/room/KickConfirmModal.astro';
import RoomSettingsModal from '../../components/room/RoomSettingsModal.astro';
import AvatarSelectModal from '../../components/room/AvatarSelectModal.astro';

import type { Participant, VotingStatus } from '../../lib/room/types';

const { id } = Astro.params;

const cookieHeader = Astro.request.headers.get('Cookie') ?? '';
const supabase = createSupabaseServerClient(Astro.cookies, cookieHeader);
const { data: { user } } = await supabase.auth.getUser();

// Fetch room
const { data: room, error } = await supabase
  .from('rooms')
  .select('*')
  .eq('id', id)
  .single();

if (error || !room) {
  return Astro.redirect('/404');
}

// Check if user has joined this room
const sessionId = Astro.cookies.get('session_id')?.value;
let currentParticipant: Participant | null = null;

if (sessionId) {
  const { data } = await supabase
    .from('room_participants')
    .select('*')
    .eq('room_id', id)
    .eq('session_id', sessionId)
    .single();
  currentParticipant = data as Participant | null;
}

// Fetch all participants (initial load)
const { data: participantsData } = await supabase
  .from('room_participants')
  .select('*')
  .eq('room_id', id)
  .order('created_at', { ascending: true });

const participants = (participantsData || []) as Participant[];
const roomUrl = `${Astro.url.origin}/room/${room.id}`;

// Pass data to client
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

const isManager = currentParticipant?.role === 'manager';
const votingStatus = (room.voting_status || 'waiting') as VotingStatus;
const currentTopic = room.current_topic || '';
const showVotes = room.show_votes ?? false;
const voteOptions = room.vote_options || ['0', '1', '2', '3', '5', '8', '13', '21', '?', 'â˜•'];
const appName = getAppName(Astro.url.hostname);
---

<Layout title={`${room.name} - ${appName}`}>
  <main class="min-h-screen flex flex-col">
    <Header user={user} showRoomInfo={true} roomName={room.name} showSettings={!!currentParticipant}>
      <div slot="extra" class="hidden md:flex items-center gap-2 bg-slate-800 rounded-lg px-3 py-1.5 border border-slate-700">
        <input
          type="text"
          readonly
          value={roomUrl}
          id="room-url"
          class="w-48 bg-transparent text-white text-sm focus:outline-none"
        />
        <button
          id="copy-btn"
          class="text-slate-400 hover:text-white transition-colors"
          title="Copy link"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="copy-icon">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
          <svg class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="check-icon">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </button>
      </div>
    </Header>

    <!-- Main Content with Sidebar -->
    <div class="flex-1 flex overflow-hidden">
      <!-- Center: Voting Area -->
      <div class="flex-1 p-6 overflow-y-auto">
        {!currentParticipant ? (
          <JoinForm roomId={id!} />
        ) : (
          <!-- Voting Interface -->
          <div class="max-w-2xl mx-auto">
            <!-- Topic Display -->
            <div class="text-center mb-6" id="topic-section">
              <p class="text-slate-400 text-sm mb-1" id="topic-label" class:list={[{ 'hidden': !currentTopic }]}>Current topic</p>
              <h2 class="text-2xl font-semibold text-white" id="current-topic-display">{currentTopic || 'No topic set'}</h2>
            </div>

            <!-- Manager Controls -->
            <ManagerControls votingStatus={votingStatus} isManager={isManager} />

            <!-- Status Banner -->
            <StatusBanner votingStatus={votingStatus} />

            <!-- Story Point Cards -->
            <VotingCards currentVote={currentParticipant?.current_vote} votingStatus={votingStatus} voteOptions={voteOptions} />

            <!-- Your Vote Display -->
            <div class="text-center mb-8" id="your-vote-section">
              <p class="text-slate-400 text-sm mb-2">Your vote</p>
              <div class="inline-flex items-center justify-center w-16 h-20 bg-slate-800 border-2 border-slate-600 rounded-xl">
                <span class="text-2xl font-bold text-white" id="your-vote-display">{currentParticipant?.current_vote || '-'}</span>
              </div>
            </div>

            <!-- Results Section -->
            <VoteResults votingStatus={votingStatus} />
          </div>
        )}
      </div>

      <!-- Right Sidebar: Participants -->
      <ParticipantsSidebar
        currentParticipant={currentParticipant}
        participants={participants}
        votingStatus={votingStatus}
        isManager={isManager}
        showVotes={showVotes}
      />
    </div>
  </main>

  <!-- Leave Room Modal -->
  <LeaveModal />

  <!-- Kick Confirm Modal -->
  <KickConfirmModal />

  <!-- Settings Modal -->
  <RoomSettingsModal
    roomName={room.name}
    showVotes={showVotes}
    voteOptions={voteOptions}
    isManager={isManager}
  />

  <!-- Avatar Select Modal -->
  {currentParticipant && (
    <AvatarSelectModal
      currentStyle={currentParticipant.avatar_style || 'adventurer'}
      currentSeed={currentParticipant.avatar_seed || currentParticipant.name}
    />
  )}
</Layout>

<!-- Hidden data for client-side JS -->
<script id="room-data" type="application/json" set:html={JSON.stringify({
  roomId: room.id,
  roomName: room.name,
  currentParticipantId: currentParticipant?.id || null,
  isManager,
  votingStatus,
  currentTopic,
  showVotes,
  voteOptions,
  currentVote: currentParticipant?.current_vote || null,
  appName,
  supabaseUrl,
  supabaseAnonKey,
})} />

<script>
  import { RoomBloc, RoomController } from '../../lib/room';

  // Get room data from embedded JSON
  const roomDataEl = document.getElementById('room-data');
  const roomData = roomDataEl ? JSON.parse(roomDataEl.textContent || '{}') : {};

  // Only initialize if we have a participant (user has joined)
  if (roomData.currentParticipantId) {
    // Create BLoC with initial state
    const bloc = new RoomBloc(
      roomData.supabaseUrl,
      roomData.supabaseAnonKey,
      {
        roomId: roomData.roomId,
        roomName: roomData.roomName,
        votingStatus: roomData.votingStatus,
        currentTopic: roomData.currentTopic,
        isManager: roomData.isManager,
        currentParticipantId: roomData.currentParticipantId,
        showVotes: roomData.showVotes,
        voteOptions: roomData.voteOptions,
        currentVote: roomData.currentVote,
        appName: roomData.appName,
      }
    );

    // Create controller and initialize
    const controller = new RoomController(bloc);
    controller.init();
  } else {
    // Handle join form for users who haven't joined yet
    const joinForm = document.getElementById('join-form') as HTMLFormElement;
    const joinButton = joinForm?.querySelector('button[type="submit"]') as HTMLButtonElement;
    const joinError = document.getElementById('join-error');

    const spinnerSvg = `<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>`;

    joinForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const originalText = joinButton?.innerHTML;
      if (joinButton) {
        joinButton.innerHTML = spinnerSvg;
        joinButton.disabled = true;
      }
      joinError?.classList.add('hidden');

      const formData = new FormData(joinForm);

      try {
        const response = await fetch(joinForm.action, {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (!response.ok) {
          if (joinError) {
            joinError.textContent = result.error || 'Failed to join room';
            joinError.classList.remove('hidden');
          }
          if (joinButton && originalText) {
            joinButton.innerHTML = originalText;
            joinButton.disabled = false;
          }
          return;
        }

        window.location.reload();
      } catch {
        if (joinError) {
          joinError.textContent = 'Failed to join room. Please try again.';
          joinError.classList.remove('hidden');
        }
        if (joinButton && originalText) {
          joinButton.innerHTML = originalText;
          joinButton.disabled = false;
        }
      }
    });

    // Copy functionality (for non-joined users too)
    const copyBtn = document.getElementById('copy-btn');
    const roomUrlInput = document.getElementById('room-url') as HTMLInputElement;
    const copyIcon = document.getElementById('copy-icon');
    const checkIcon = document.getElementById('check-icon');

    copyBtn?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(roomUrlInput.value);
        copyIcon?.classList.add('hidden');
        checkIcon?.classList.remove('hidden');
        setTimeout(() => {
          copyIcon?.classList.remove('hidden');
          checkIcon?.classList.add('hidden');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });
  }
</script>
