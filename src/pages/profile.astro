---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import { createSupabaseServerClient } from '../lib/supabase';
import { getAppName } from '../lib/branding';

const cookieHeader = Astro.request.headers.get('Cookie') ?? '';
const supabase = createSupabaseServerClient(Astro.cookies, cookieHeader);
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

// Get profile
const { data: profile } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', user.id)
  .single();

const appName = getAppName(Astro.url.hostname);

// DiceBear avatar styles
const avatarStyles = [
  { id: 'avataaars', name: 'Avataaars' },
  { id: 'bottts', name: 'Robots' },
  { id: 'fun-emoji', name: 'Fun Emoji' },
  { id: 'lorelei', name: 'Lorelei' },
  { id: 'notionists', name: 'Notionists' },
  { id: 'open-peeps', name: 'Open Peeps' },
  { id: 'personas', name: 'Personas' },
  { id: 'pixel-art', name: 'Pixel Art' },
  { id: 'thumbs', name: 'Thumbs' },
  { id: 'initials', name: 'Initials' },
];

// Parse current avatar URL to get style and seed
const avatarMatch = profile?.avatar_url?.match(/api\.dicebear\.com\/\d+\.x\/([^/]+)\/svg\?seed=([^&]+)/);
const currentStyle = avatarMatch?.[1] || 'avataaars';
const currentSeed = avatarMatch?.[2] ? decodeURIComponent(avatarMatch[2]) : (user.email || user.id);

const userWithProfile = {
  email: user.email,
  displayName: profile?.display_name,
  avatarUrl: profile?.avatar_url,
};
---

<Layout title={`Profile - ${appName}`}>
  <Header user={userWithProfile} />

  <main class="container mx-auto px-4 py-8 max-w-2xl">
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-content-primary">Profile Settings</h1>
      <p class="text-content-muted mt-1">Manage your account information</p>
    </div>

    <!-- Profile Form -->
    <div class="bg-surface-card rounded-2xl border border-border-default p-6 mb-6">
      <form id="profile-form" class="space-y-6" data-user-id={user.id} data-user-email={user.email}>
        <!-- Avatar Preview -->
        <div class="flex items-center gap-4">
          <img
            id="avatar-preview"
            src={`https://api.dicebear.com/9.x/${currentStyle}/svg?seed=${encodeURIComponent(currentSeed)}`}
            alt="Avatar"
            class="w-20 h-20 rounded-full bg-surface-elevated"
          />
          <div>
            <p class="font-medium text-content-primary">{profile?.display_name || 'No display name set'}</p>
            <p class="text-sm text-content-muted">{user.email}</p>
          </div>
        </div>

        <!-- Display Name -->
        <div>
          <label for="display_name" class="block text-sm font-medium text-content-secondary mb-1.5">
            Display Name
          </label>
          <input
            type="text"
            id="display_name"
            name="display_name"
            value={profile?.display_name || ''}
            maxlength="100"
            placeholder="Enter your display name"
            class="w-full px-4 py-2.5 bg-surface-elevated border border-border-default rounded-xl text-content-primary placeholder-content-muted focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
          />
          <p class="text-xs text-content-muted mt-1">This is how you'll appear to other users</p>
        </div>

        <!-- Avatar Style -->
        <div>
          <label class="block text-sm font-medium text-content-secondary mb-3">
            Avatar Style
          </label>
          <div class="grid grid-cols-5 gap-2" id="avatar-styles">
            {avatarStyles.map((style) => (
              <button
                type="button"
                class={`p-1.5 rounded-xl border-2 transition-all hover:scale-105 ${style.id === currentStyle ? 'border-brand bg-brand/10' : 'border-border-default hover:border-brand/50'}`}
                data-style={style.id}
                title={style.name}
              >
                <img
                  src={`https://api.dicebear.com/9.x/${style.id}/svg?seed=${encodeURIComponent(currentSeed)}`}
                  alt={style.name}
                  class="w-full aspect-square rounded-lg"
                />
              </button>
            ))}
          </div>
        </div>

        <!-- Avatar Variations -->
        <div>
          <div class="flex items-center justify-between mb-3">
            <label class="block text-sm font-medium text-content-secondary">
              Choose Variation
            </label>
            <button
              type="button"
              id="randomize-btn"
              class="text-sm text-brand hover:text-brand-hover flex items-center gap-1 transition-colors"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Randomize
            </button>
          </div>
          <div class="grid grid-cols-6 gap-2" id="avatar-variations">
            <!-- Variations will be populated by JS -->
          </div>
          <input type="hidden" id="avatar_style" name="avatar_style" value={currentStyle} />
          <input type="hidden" id="avatar_seed" name="avatar_seed" value={currentSeed} />
        </div>

        <div id="profile-error" class="hidden text-sm text-status-error bg-status-error/10 px-4 py-2 rounded-lg">
        </div>

        <div id="profile-success" class="hidden text-sm text-status-success bg-status-success/10 px-4 py-2 rounded-lg">
          Profile updated successfully!
        </div>

        <button
          type="submit"
          id="save-btn"
          class="px-6 py-2.5 bg-brand text-white rounded-xl font-medium hover:bg-brand-hover transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Save Changes
        </button>
      </form>
    </div>

    <!-- Account Info -->
    <div class="bg-surface-card rounded-2xl border border-border-default p-6 mb-6">
      <h2 class="text-lg font-semibold text-content-primary mb-4">Account Information</h2>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-content-muted mb-1">Email</label>
          <p class="text-content-primary">{user.email}</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-content-muted mb-1">User ID</label>
          <p class="text-content-secondary text-sm font-mono bg-surface-elevated px-3 py-2 rounded-lg">{user.id}</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-content-muted mb-1">Account Created</label>
          <p class="text-content-primary">{new Date(user.created_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}</p>
        </div>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="bg-surface-card rounded-2xl border border-status-error/30 p-6">
      <h2 class="text-lg font-semibold text-status-error mb-4">Sign Out</h2>
      <p class="text-content-secondary text-sm mb-4">Sign out of your account on this device.</p>
      <form method="POST" action="/api/auth/signout">
        <button
          type="submit"
          class="px-6 py-2.5 bg-status-error text-white rounded-xl font-medium hover:bg-status-error/90 transition-colors"
        >
          Sign Out
        </button>
      </form>
    </div>
  </main>
</Layout>

<script>
  function initProfile() {
    const form = document.getElementById('profile-form') as HTMLFormElement;
    const displayNameInput = document.getElementById('display_name') as HTMLInputElement;
    const avatarStyleInput = document.getElementById('avatar_style') as HTMLInputElement;
    const avatarSeedInput = document.getElementById('avatar_seed') as HTMLInputElement;
    const avatarPreview = document.getElementById('avatar-preview') as HTMLImageElement;
    const avatarStylesContainer = document.getElementById('avatar-styles');
    const avatarVariationsContainer = document.getElementById('avatar-variations');
    const randomizeBtn = document.getElementById('randomize-btn');
    const errorDiv = document.getElementById('profile-error') as HTMLDivElement;
    const successDiv = document.getElementById('profile-success') as HTMLDivElement;
    const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;

    if (!form || !avatarStylesContainer || !avatarVariationsContainer) return;

    const userId = form.dataset.userId || '';
    const userEmail = form.dataset.userEmail || '';

    // Generate random seed
    const generateSeed = () => Math.random().toString(36).substring(2, 10);

    // Generate variations for a style
    const generateVariations = (style: string, currentSeed: string) => {
      const seeds = [currentSeed];
      // Add 5 more random seeds
      for (let i = 0; i < 5; i++) {
        seeds.push(generateSeed());
      }

      avatarVariationsContainer.innerHTML = seeds.map((seed, i) => `
        <button
          type="button"
          class="p-1 rounded-xl border-2 transition-all hover:scale-105 ${i === 0 ? 'border-brand bg-brand/10' : 'border-border-default hover:border-brand/50'}"
          data-variation-seed="${seed}"
        >
          <img
            src="https://api.dicebear.com/9.x/${style}/svg?seed=${encodeURIComponent(seed)}"
            alt="Variation ${i + 1}"
            class="w-full aspect-square rounded-lg"
          />
        </button>
      `).join('');

      // Add click handlers
      avatarVariationsContainer.querySelectorAll('button[data-variation-seed]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const seed = (btn as HTMLElement).dataset.variationSeed;
          if (!seed) return;

          // Update seed input
          avatarSeedInput.value = seed;

          // Update preview
          const style = avatarStyleInput.value;
          avatarPreview.src = `https://api.dicebear.com/9.x/${style}/svg?seed=${encodeURIComponent(seed)}`;

          // Update visual selection
          avatarVariationsContainer.querySelectorAll('button[data-variation-seed]').forEach((b) => {
            b.classList.remove('border-brand', 'bg-brand/10');
            b.classList.add('border-border-default');
          });
          btn.classList.remove('border-border-default');
          btn.classList.add('border-brand', 'bg-brand/10');
        });
      });
    };

    // Initialize variations
    generateVariations(avatarStyleInput.value, avatarSeedInput.value);

    // Handle avatar style selection
    avatarStylesContainer.querySelectorAll('button[data-style]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const style = (btn as HTMLElement).dataset.style;
        if (!style) return;

        // Update hidden input
        avatarStyleInput.value = style;

        // Update style previews with current seed
        const currentSeed = avatarSeedInput.value;
        avatarStylesContainer.querySelectorAll('button[data-style] img').forEach((img) => {
          const imgStyle = (img as HTMLImageElement).closest('button')?.dataset.style;
          if (imgStyle) {
            (img as HTMLImageElement).src = `https://api.dicebear.com/9.x/${imgStyle}/svg?seed=${encodeURIComponent(currentSeed)}`;
          }
        });

        // Update preview
        avatarPreview.src = `https://api.dicebear.com/9.x/${style}/svg?seed=${encodeURIComponent(currentSeed)}`;

        // Update visual selection
        avatarStylesContainer.querySelectorAll('button[data-style]').forEach((b) => {
          b.classList.remove('border-brand', 'bg-brand/10');
          b.classList.add('border-border-default');
        });
        btn.classList.remove('border-border-default');
        btn.classList.add('border-brand', 'bg-brand/10');

        // Generate new variations for this style
        generateVariations(style, currentSeed);
      });
    });

    // Randomize button
    randomizeBtn?.addEventListener('click', () => {
      const style = avatarStyleInput.value;
      const newSeed = generateSeed();
      avatarSeedInput.value = newSeed;
      avatarPreview.src = `https://api.dicebear.com/9.x/${style}/svg?seed=${encodeURIComponent(newSeed)}`;
      generateVariations(style, newSeed);
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      const style = avatarStyleInput.value;
      const seed = avatarSeedInput.value;
      const avatarUrl = `https://api.dicebear.com/9.x/${style}/svg?seed=${encodeURIComponent(seed)}`;

      try {
        const response = await fetch('/api/profile', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            display_name: displayNameInput.value.trim() || null,
            avatar_url: avatarUrl,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to update profile');
        }

        successDiv.classList.remove('hidden');
        setTimeout(() => successDiv.classList.add('hidden'), 3000);
      } catch (err) {
        errorDiv.textContent = err instanceof Error ? err.message : 'Failed to update profile';
        errorDiv.classList.remove('hidden');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    });
  }

  initProfile();
  document.addEventListener('astro:page-load', initProfile);
</script>
