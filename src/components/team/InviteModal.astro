---
import Dropdown from '../ui/Dropdown.astro';

interface Props {
  teamSlug: string;
}

const { teamSlug } = Astro.props;

const roleOptions = [
  { value: 'member', label: 'Member' },
  { value: 'admin', label: 'Admin' },
];

const expiresOptions = [
  { value: '1', label: '1 day' },
  { value: '7', label: '7 days' },
  { value: '30', label: '30 days' },
  { value: '', label: 'Never' },
];
---

<div
  id="invite-modal"
  class="fixed inset-0 z-50 hidden items-center justify-center p-4"
  role="dialog"
  aria-modal="true"
  aria-labelledby="invite-modal-title"
  data-team-slug={teamSlug}
>
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" data-modal-backdrop></div>

  <!-- Modal -->
  <div class="relative w-full max-w-md bg-surface-card rounded-2xl shadow-xl border border-border-default">
    <div class="p-6">
      <h2 id="invite-modal-title" class="text-xl font-semibold text-content-primary mb-4">
        Invite Team Members
      </h2>

      <!-- Tabs -->
      <div class="flex gap-2 mb-4 p-1 bg-surface-elevated rounded-xl">
        <button
          type="button"
          class="flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-surface-card text-content-primary shadow-sm"
          data-tab="link"
          data-active="true"
        >
          Invite Link
        </button>
        <button
          type="button"
          class="flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-colors text-content-muted hover:text-content-primary"
          data-tab="email"
        >
          Email Invite
        </button>
      </div>

      <!-- Link Tab -->
      <div id="invite-link-tab" class="space-y-4">
        <p class="text-sm text-content-secondary">
          Create a shareable link that anyone can use to join your team.
        </p>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-content-secondary mb-1.5">
              Role
            </label>
            <Dropdown id="link-role" options={roleOptions} value="member" />
          </div>
          <div>
            <label class="block text-sm font-medium text-content-secondary mb-1.5">
              Expires in
            </label>
            <Dropdown id="link-expires" options={expiresOptions} value="7" />
          </div>
        </div>

        <div id="invite-link-result" class="hidden">
          <label class="block text-sm font-medium text-content-secondary mb-1.5">
            Invite Link
          </label>
          <div class="flex gap-2">
            <input
              type="text"
              id="invite-link-input"
              readonly
              class="flex-1 px-4 py-2.5 bg-surface-elevated border border-border-default rounded-xl text-content-primary text-sm"
            />
            <button
              type="button"
              id="copy-link-btn"
              class="px-4 py-2.5 bg-brand text-white rounded-xl font-medium hover:bg-brand-hover transition-colors"
            >
              Copy
            </button>
          </div>
          <p id="link-expires-note" class="text-xs text-content-muted mt-2">
          </p>
        </div>

        <button
          type="button"
          id="generate-link-btn"
          class="w-full px-4 py-2.5 bg-brand text-white rounded-xl font-medium hover:bg-brand-hover transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Generate Invite Link
        </button>
      </div>

      <!-- Email Tab -->
      <div id="invite-email-tab" class="hidden space-y-4">
        <p class="text-sm text-content-secondary">
          Send an invitation directly to someone's email address.
        </p>

        <form id="email-invite-form" class="space-y-4">
          <div>
            <label for="invite-email" class="block text-sm font-medium text-content-secondary mb-1.5">
              Email Addresses
            </label>
            <div class="min-h-[46px] p-2 bg-surface-elevated border border-border-default rounded-xl focus-within:ring-2 focus-within:ring-brand">
              <div id="email-pills" class="flex flex-wrap gap-1.5 mb-1.5 empty:mb-0"></div>
              <input
                type="email"
                id="invite-email"
                placeholder="Type email and press Enter"
                class="w-full bg-transparent text-content-primary placeholder-content-muted focus:outline-none text-sm"
              />
            </div>
            <p class="text-xs text-content-muted mt-1">Press Enter or comma to add multiple emails</p>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-content-secondary mb-1.5">
                Role
              </label>
              <Dropdown id="email-role" options={roleOptions} value="member" />
            </div>
            <div>
              <label class="block text-sm font-medium text-content-secondary mb-1.5">
                Expires in
              </label>
              <Dropdown id="email-expires" options={expiresOptions} value="7" />
            </div>
          </div>

          <div id="email-invite-error" class="hidden text-sm text-status-error bg-status-error/10 px-4 py-2 rounded-lg">
          </div>

          <div id="email-invite-success" class="hidden text-sm text-status-success bg-status-success/10 px-4 py-2 rounded-lg">
            Invitation sent successfully!
          </div>

          <button
            type="submit"
            class="w-full px-4 py-2.5 bg-brand text-white rounded-xl font-medium hover:bg-brand-hover transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Send Invitations
          </button>
        </form>
      </div>

      <div class="mt-4 pt-4 border-t border-border-default">
        <button
          type="button"
          data-modal-close
          class="w-full px-4 py-2.5 bg-surface-elevated text-content-primary rounded-xl font-medium hover:bg-surface-hover transition-colors"
        >
          Done
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  import { createInvitation } from '../../lib/team/api';

  function initInviteModal() {
    const modal = document.getElementById('invite-modal');
    if (!modal) return;

    const teamSlug = modal.dataset.teamSlug;
    if (!teamSlug) return;

    const backdrop = modal.querySelector('[data-modal-backdrop]');
    const closeBtn = modal.querySelector('[data-modal-close]');
    const linkTab = document.getElementById('invite-link-tab');
    const emailTab = document.getElementById('invite-email-tab');
    const tabBtns = modal.querySelectorAll('[data-tab]');

    // Tab switching
    tabBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        const tab = (btn as HTMLElement).dataset.tab;

        tabBtns.forEach((b) => {
          const isActive = (b as HTMLElement).dataset.tab === tab;
          (b as HTMLElement).dataset.active = isActive ? 'true' : 'false';
          if (isActive) {
            b.classList.add('bg-surface-card', 'text-content-primary', 'shadow-sm');
            b.classList.remove('text-content-muted');
          } else {
            b.classList.remove('bg-surface-card', 'text-content-primary', 'shadow-sm');
            b.classList.add('text-content-muted');
          }
        });

        if (tab === 'link') {
          linkTab?.classList.remove('hidden');
          emailTab?.classList.add('hidden');
        } else {
          linkTab?.classList.add('hidden');
          emailTab?.classList.remove('hidden');
        }
      });
    });

    // Close modal
    const closeModal = () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    };

    backdrop?.addEventListener('click', closeModal);
    closeBtn?.addEventListener('click', closeModal);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });

    // Generate link
    const generateBtn = document.getElementById('generate-link-btn');
    const linkResult = document.getElementById('invite-link-result');
    const linkInput = document.getElementById('invite-link-input') as HTMLInputElement;
    const linkRoleInput = document.getElementById('link-role-input') as HTMLInputElement;
    const linkExpiresInput = document.getElementById('link-expires-input') as HTMLInputElement;
    const linkExpiresNote = document.getElementById('link-expires-note');
    const copyBtn = document.getElementById('copy-link-btn');

    generateBtn?.addEventListener('click', async () => {
      generateBtn.setAttribute('disabled', 'true');
      generateBtn.textContent = 'Generating...';

      try {
        const expiresInDays = linkExpiresInput.value ? parseInt(linkExpiresInput.value) : undefined;
        const result = await createInvitation(teamSlug, {
          type: 'link',
          role: linkRoleInput.value as 'admin' | 'member',
          expiresInDays,
        });

        const inviteUrl = `${window.location.origin}/invite/${result.token}`;
        linkInput.value = inviteUrl;
        linkResult?.classList.remove('hidden');
        generateBtn.classList.add('hidden');

        // Update note text
        if (linkExpiresNote) {
          const expiresText = expiresInDays ? `expires in ${expiresInDays} day${expiresInDays > 1 ? 's' : ''}` : 'never expires';
          linkExpiresNote.textContent = `This link ${expiresText} and can be used unlimited times.`;
        }
      } catch (err) {
        window.showAlert?.(err instanceof Error ? err.message : 'An error occurred', {
          type: 'error',
          title: 'Failed to generate link',
        });
        generateBtn.removeAttribute('disabled');
        generateBtn.textContent = 'Generate Invite Link';
      }
    });

    // Copy link
    copyBtn?.addEventListener('click', async () => {
      await navigator.clipboard.writeText(linkInput.value);
      copyBtn.textContent = 'Copied!';
      setTimeout(() => {
        copyBtn.textContent = 'Copy';
      }, 2000);
    });

    // Email invite form
    const emailForm = document.getElementById('email-invite-form') as HTMLFormElement;
    const emailInput = document.getElementById('invite-email') as HTMLInputElement;
    const emailPills = document.getElementById('email-pills');
    const emailRoleInput = document.getElementById('email-role-input') as HTMLInputElement;
    const emailExpiresInput = document.getElementById('email-expires-input') as HTMLInputElement;
    const emailError = document.getElementById('email-invite-error');
    const emailSuccess = document.getElementById('email-invite-success');

    const emails: string[] = [];

    const isValidEmail = (email: string) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

    const addEmail = (email: string) => {
      const trimmed = email.trim().toLowerCase();
      if (!trimmed || !isValidEmail(trimmed) || emails.includes(trimmed)) return;

      emails.push(trimmed);

      const pill = document.createElement('span');
      pill.className = 'inline-flex items-center gap-1 px-2 py-1 bg-brand/10 text-brand rounded-lg text-sm';
      pill.innerHTML = `
        <span>${trimmed}</span>
        <button type="button" class="hover:text-brand-hover" data-remove-email="${trimmed}">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      `;
      emailPills?.appendChild(pill);
      emailInput.value = '';
    };

    const removeEmail = (email: string) => {
      const idx = emails.indexOf(email);
      if (idx > -1) emails.splice(idx, 1);
      const pill = emailPills?.querySelector(`[data-remove-email="${email}"]`)?.parentElement;
      pill?.remove();
    };

    emailPills?.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest('[data-remove-email]') as HTMLElement;
      if (btn) removeEmail(btn.dataset.removeEmail!);
    });

    emailInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ',' || e.key === ' ') {
        e.preventDefault();
        addEmail(emailInput.value);
      } else if (e.key === 'Backspace' && !emailInput.value && emails.length > 0) {
        removeEmail(emails[emails.length - 1]);
      }
    });

    emailInput?.addEventListener('blur', () => {
      if (emailInput.value.trim()) addEmail(emailInput.value);
    });

    emailForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Add any remaining text in input
      if (emailInput.value.trim()) addEmail(emailInput.value);

      if (emails.length === 0) {
        if (emailError) {
          emailError.textContent = 'Please add at least one email address';
          emailError.classList.remove('hidden');
        }
        return;
      }

      const submitBtn = emailForm.querySelector('button[type="submit"]') as HTMLButtonElement;
      submitBtn.disabled = true;
      emailError?.classList.add('hidden');
      emailSuccess?.classList.add('hidden');

      const expiresInDays = emailExpiresInput.value ? parseInt(emailExpiresInput.value) : undefined;
      const results: { success: string[]; failed: string[] } = { success: [], failed: [] };

      for (const email of [...emails]) {
        submitBtn.textContent = `Sending ${results.success.length + results.failed.length + 1}/${emails.length}...`;
        try {
          await createInvitation(teamSlug, {
            type: 'email',
            email,
            role: emailRoleInput.value as 'admin' | 'member',
            expiresInDays,
          });
          results.success.push(email);
          removeEmail(email);
        } catch (err) {
          results.failed.push(email);
        }
      }

      if (results.success.length > 0 && emailSuccess) {
        emailSuccess.textContent = `${results.success.length} invitation${results.success.length > 1 ? 's' : ''} sent successfully!`;
        emailSuccess.classList.remove('hidden');
      }

      if (results.failed.length > 0 && emailError) {
        emailError.textContent = `Failed to send to: ${results.failed.join(', ')}`;
        emailError.classList.remove('hidden');
      }

      submitBtn.disabled = false;
      submitBtn.textContent = 'Send Invitations';
    });
  }

  initInviteModal();
  document.addEventListener('astro:page-load', initInviteModal);

  // Export function to open modal
  (window as any).openInviteModal = () => {
    const modal = document.getElementById('invite-modal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      // Reset link tab state
      const linkResult = document.getElementById('invite-link-result');
      const generateBtn = document.getElementById('generate-link-btn');
      linkResult?.classList.add('hidden');
      generateBtn?.classList.remove('hidden');
      generateBtn?.removeAttribute('disabled');
      if (generateBtn) generateBtn.textContent = 'Generate Invite Link';

      // Reset email tab state
      const emailPills = document.getElementById('email-pills');
      const emailInput = document.getElementById('invite-email') as HTMLInputElement;
      const emailError = document.getElementById('email-invite-error');
      const emailSuccess = document.getElementById('email-invite-success');
      if (emailPills) emailPills.innerHTML = '';
      if (emailInput) emailInput.value = '';
      emailError?.classList.add('hidden');
      emailSuccess?.classList.add('hidden');
    }
  };
</script>
