---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import { createSupabaseServerClient } from '../../lib/supabase';
import { getAppName } from '../../lib/branding';

// Room components
import JoinForm from '../../components/room/JoinForm.astro';
import VotingCards from '../../components/room/VotingCards.astro';
import ManagerControls from '../../components/room/ManagerControls.astro';
import StatusBanner from '../../components/room/StatusBanner.astro';
import ParticipantsSidebar from '../../components/room/ParticipantsSidebar.astro';
import VoteResults from '../../components/room/VoteResults.astro';
import LeaveModal from '../../components/room/LeaveModal.astro';
import KickConfirmModal from '../../components/room/KickConfirmModal.astro';
import RoomSettingsModal from '../../components/room/RoomSettingsModal.astro';
import AvatarSelectModal from '../../components/room/AvatarSelectModal.astro';

import type { Participant, VotingStatus } from '../../lib/room/types';

const { id } = Astro.params;

const cookieHeader = Astro.request.headers.get('Cookie') ?? '';
const supabase = createSupabaseServerClient(Astro.cookies, cookieHeader);
const { data: { user } } = await supabase.auth.getUser();

// Fetch room with team info
const { data: room, error } = await supabase
  .from('rooms')
  .select(`
    *,
    teams (
      id,
      name,
      slug
    )
  `)
  .eq('id', id)
  .single();

if (error || !room) {
  return Astro.redirect('/404');
}

// If this is a team room, verify user has access
const team = room.teams as { id: string; name: string; slug: string } | null;
let isTeamMember = false;

if (team) {
  if (!user) {
    // Team rooms require authentication
    return Astro.redirect(`/login?redirect=/room/${id}`);
  }

  // Check if user is a team member
  const { data: membership } = await supabase
    .from('team_members')
    .select('id')
    .eq('team_id', team.id)
    .eq('user_id', user.id)
    .single();

  if (!membership) {
    // User is not a team member, redirect to teams page
    return Astro.redirect('/teams');
  }

  isTeamMember = true;
}

// Check if user has joined this room
let sessionId = Astro.cookies.get('session_id')?.value;
let currentParticipant: Participant | null = null;

if (sessionId) {
  const { data } = await supabase
    .from('room_participants')
    .select('*')
    .eq('room_id', id)
    .eq('session_id', sessionId)
    .single();
  currentParticipant = data as Participant | null;
}

// Auto-join signed-in users who haven't joined yet
if (user && !currentParticipant) {
  // Get user's profile for display name
  const { data: profile } = await supabase
    .from('profiles')
    .select('display_name, email, avatar_url')
    .eq('id', user.id)
    .single();

  const displayName = profile?.display_name || profile?.email || user.email || 'Anonymous';

  // Create session ID if needed
  if (!sessionId) {
    sessionId = crypto.randomUUID();
    Astro.cookies.set('session_id', sessionId, {
      path: '/',
      httpOnly: true,
      secure: import.meta.env.PROD,
      sameSite: 'lax',
      maxAge: 60 * 60 * 24 * 7, // 1 week
    });
  }

  // Check if this user is the room creator
  const isCreator = room.creator_session_id === sessionId;

  // Check if there's already a manager
  const { data: existingManager } = await supabase
    .from('room_participants')
    .select('id')
    .eq('room_id', id)
    .eq('role', 'manager')
    .limit(1)
    .single();

  const role = (isCreator && !existingManager) ? 'manager' : 'member';

  // Generate random avatar
  const avatarStyles = ['adventurer', 'big-smile', 'bottts', 'fun-emoji', 'lorelei', 'micah', 'notionists', 'pixel-art', 'thumbs', 'avataaars'];
  const avatarStyle = avatarStyles[Math.floor(Math.random() * avatarStyles.length)];
  const avatarSeed = `auto-${Date.now()}`;

  // Auto-join the user
  const { data: newParticipant, error: joinError } = await supabase
    .from('room_participants')
    .insert({
      room_id: id,
      name: displayName,
      user_id: user.id,
      session_id: sessionId,
      role,
      avatar_style: avatarStyle,
      avatar_seed: avatarSeed,
    })
    .select()
    .single();

  if (!joinError && newParticipant) {
    currentParticipant = newParticipant as Participant;
  }
}

// Fetch all participants (initial load)
const { data: participantsData } = await supabase
  .from('room_participants')
  .select('*')
  .eq('room_id', id)
  .order('created_at', { ascending: true });

const participants = (participantsData || []) as Participant[];
const roomUrl = `${Astro.url.origin}/room/${room.id}`;

// Pass data to client
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

const isManager = currentParticipant?.role === 'manager';
const votingStatus = (room.voting_status || 'waiting') as VotingStatus;
const currentTopic = room.current_topic || '';
const showVotes = room.show_votes ?? false;
const voteOptions = room.vote_options || ['0', '1', '2', '3', '5', '8', '13', '21', '?', 'â˜•'];
const appName = getAppName(Astro.url.hostname);
---

<Layout title={`${room.name} - ${appName}`}>
  <main class="min-h-screen flex flex-col">
    <Header user={user} variant="room" roomName={room.name} showSettings={!!currentParticipant} participantCount={participants.length} roomUrl={roomUrl}>
      <div slot="extra" class="hidden md:flex items-center gap-2 bg-surface-secondary rounded-lg px-3 py-1.5 border border-border-default">
        <input
          type="text"
          readonly
          value={roomUrl}
          id="room-url"
          class="w-48 bg-transparent text-content-primary text-sm focus:outline-none"
        />
        <button
          id="copy-btn"
          class="text-content-muted hover:text-content-primary transition-colors"
          title="Copy link"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="copy-icon">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
          <svg class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="check-icon">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </button>
      </div>
    </Header>

    <!-- Main Content with Sidebar -->
    <div class="flex-1 flex overflow-hidden">
      <!-- Center: Voting Area -->
      <div class="flex-1 p-6 overflow-y-auto">
        {!currentParticipant ? (
          <JoinForm roomId={id!} />
        ) : (
          <!-- Voting Interface -->
          <div class="max-w-2xl mx-auto">
            <!-- Topic Display -->
            <div class="text-center mb-6" id="topic-section">
              <p class="text-content-muted text-sm mb-1" id="topic-label" class:list={[{ 'hidden': !currentTopic }]}>Current topic</p>
              <h2 class="text-2xl font-semibold text-content-primary" id="current-topic-display">{currentTopic || 'No topic set'}</h2>
            </div>

            <!-- Manager Controls -->
            <ManagerControls votingStatus={votingStatus} isManager={isManager} />

            <!-- Status Banner -->
            <StatusBanner votingStatus={votingStatus} />

            <!-- Story Point Cards -->
            <VotingCards currentVote={currentParticipant?.current_vote} votingStatus={votingStatus} voteOptions={voteOptions} />

            <!-- Your Vote Display -->
            <div class="text-center mb-8" id="your-vote-section">
              <p class="text-content-muted text-sm mb-2">Your vote</p>
              <div class="inline-flex items-center justify-center w-16 h-20 bg-surface-secondary border-2 border-border-default rounded-xl">
                <span class="text-2xl font-bold text-content-primary" id="your-vote-display">{currentParticipant?.current_vote || '-'}</span>
              </div>
            </div>

            <!-- Results Section -->
            <VoteResults votingStatus={votingStatus} />
          </div>
        )}
      </div>

      <!-- Right Sidebar: Participants (desktop) -->
      <ParticipantsSidebar
        currentParticipant={currentParticipant}
        participants={participants}
        votingStatus={votingStatus}
        isManager={isManager}
        showVotes={showVotes}
      />
    </div>


    <!-- Mobile Participants Drawer -->
    {currentParticipant && (
      <div id="mobile-participants-drawer" class="lg:hidden fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div id="drawer-backdrop" class="absolute inset-0 bg-black/50"></div>

        <!-- Drawer -->
        <div id="drawer-panel" class="absolute right-0 top-0 bottom-0 w-80 max-w-[85vw] bg-surface-card border-l border-border-default transform translate-x-full transition-transform duration-300">
          <!-- Header -->
          <div class="flex items-center justify-between p-4 border-b border-border-default">
            <h2 class="text-content-primary font-semibold">Participants</h2>
            <button id="close-drawer-btn" class="text-content-muted hover:text-content-primary p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <!-- Participants list (will be synced with main sidebar via JS) -->
          <div id="mobile-participants-content" class="overflow-y-auto h-full pb-20">
            <!-- Content will be cloned from main sidebar -->
          </div>
        </div>
      </div>
    )}
  </main>

  <!-- Leave Room Modal -->
  <LeaveModal />

  <!-- Kick Confirm Modal -->
  <KickConfirmModal />

  <!-- Settings Modal -->
  <RoomSettingsModal
    roomName={room.name}
    showVotes={showVotes}
    voteOptions={voteOptions}
    isManager={isManager}
  />

  <!-- Avatar Select Modal -->
  {currentParticipant && (
    <AvatarSelectModal
      currentStyle={currentParticipant.avatar_style || 'adventurer'}
      currentSeed={currentParticipant.avatar_seed || currentParticipant.name}
    />
  )}
</Layout>

<!-- Hidden data for client-side JS -->
<script id="room-data" type="application/json" set:html={JSON.stringify({
  roomId: room.id,
  roomName: room.name,
  currentParticipantId: currentParticipant?.id || null,
  isManager,
  votingStatus,
  currentTopic,
  showVotes,
  voteOptions,
  currentVote: currentParticipant?.current_vote || null,
  appName,
  supabaseUrl,
  supabaseAnonKey,
  teamSlug: team?.slug || null,
})} />

<script>
  import { RoomBloc, RoomController } from '../../lib/room';

  // Get room data from embedded JSON
  const roomDataEl = document.getElementById('room-data');
  const roomData = roomDataEl ? JSON.parse(roomDataEl.textContent || '{}') : {};

  // Only initialize if we have a participant (user has joined)
  if (roomData.currentParticipantId) {
    // Create BLoC with initial state
    const bloc = new RoomBloc(
      roomData.supabaseUrl,
      roomData.supabaseAnonKey,
      {
        roomId: roomData.roomId,
        roomName: roomData.roomName,
        votingStatus: roomData.votingStatus,
        currentTopic: roomData.currentTopic,
        isManager: roomData.isManager,
        currentParticipantId: roomData.currentParticipantId,
        showVotes: roomData.showVotes,
        voteOptions: roomData.voteOptions,
        currentVote: roomData.currentVote,
        appName: roomData.appName,
      }
    );

    // Create controller and initialize
    const controller = new RoomController(bloc);
    controller.init();
  } else {
    // Handle join form for users who haven't joined yet
    const joinForm = document.getElementById('join-form') as HTMLFormElement;
    const joinButton = joinForm?.querySelector('button[type="submit"]') as HTMLButtonElement;
    const joinError = document.getElementById('join-error');

    const spinnerSvg = `<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>`;

    joinForm?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const originalText = joinButton?.innerHTML;
      if (joinButton) {
        joinButton.innerHTML = spinnerSvg;
        joinButton.disabled = true;
      }
      joinError?.classList.add('hidden');

      const formData = new FormData(joinForm);

      try {
        const response = await fetch(joinForm.action, {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (!response.ok) {
          if (joinError) {
            joinError.textContent = result.error || 'Failed to join room';
            joinError.classList.remove('hidden');
          }
          if (joinButton && originalText) {
            joinButton.innerHTML = originalText;
            joinButton.disabled = false;
          }
          return;
        }

        window.location.reload();
      } catch {
        if (joinError) {
          joinError.textContent = 'Failed to join room. Please try again.';
          joinError.classList.remove('hidden');
        }
        if (joinButton && originalText) {
          joinButton.innerHTML = originalText;
          joinButton.disabled = false;
        }
      }
    });

    // Copy functionality (for non-joined users too)
    const copyBtn = document.getElementById('copy-btn');
    const roomUrlInput = document.getElementById('room-url') as HTMLInputElement;
    const copyIcon = document.getElementById('copy-icon');
    const checkIcon = document.getElementById('check-icon');

    copyBtn?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(roomUrlInput.value);
        copyIcon?.classList.add('hidden');
        checkIcon?.classList.remove('hidden');
        setTimeout(() => {
          copyIcon?.classList.remove('hidden');
          checkIcon?.classList.add('hidden');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });
  }
</script>
