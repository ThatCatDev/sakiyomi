---
import Layout from '../layouts/Layout.astro';
import { getAppName } from '../lib/branding';

const appName = getAppName(Astro.url.hostname);
---

<Layout title={`Reset Password - ${appName}`}>
  <main class="min-h-screen flex flex-col p-4">
    <!-- Back link -->
    <div class="max-w-md mx-auto w-full pt-4">
      <a href="/" class="inline-flex items-center gap-2 text-content-secondary hover:text-content-primary transition-colors text-sm">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to home
      </a>
    </div>

    <div class="flex-1 flex items-center justify-center">
    <div class="w-full max-w-md">
      <!-- Logo/Brand -->
      <div class="text-center mb-8">
        <a href="/" class="inline-block">
          <img src="/logo.svg" alt={appName} class="w-16 h-16 mx-auto mb-4" />
          <h1 class="text-2xl font-bold text-content-primary">{appName}</h1>
        </a>
        <p class="text-content-muted mt-2">Set your new password</p>
      </div>

      <!-- Reset Password Card -->
      <div class="bg-surface-card rounded-2xl shadow-xl p-8 border border-border-default">
        <!-- Loading State -->
        <div id="loading-container" class="text-center py-8">
          <div class="animate-spin w-8 h-8 mx-auto mb-4 border-2 border-brand border-t-transparent rounded-full"></div>
          <p class="text-content-muted">Verifying your link...</p>
        </div>

        <!-- Error State -->
        <div id="error-container" class="hidden text-center">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-status-error/10 flex items-center justify-center">
            <svg class="w-8 h-8 text-status-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </div>
          <h2 class="text-lg font-semibold text-content-primary mb-2">Invalid or Expired Link</h2>
          <p class="text-content-secondary text-sm mb-6" id="error-detail">
            This password reset link is invalid or has expired. Please request a new one.
          </p>
          <a
            href="/forgot-password"
            class="inline-block px-6 py-2.5 bg-brand text-white font-medium rounded-xl hover:bg-brand-hover transition-colors"
          >
            Request New Link
          </a>
        </div>

        <!-- Reset Form -->
        <div id="form-container" class="hidden">
          <form id="reset-password-form" method="POST" action="#" class="space-y-6">
            <div>
              <label for="password" class="block text-sm font-medium text-content-secondary mb-2">
                New Password
              </label>
              <input
                type="password"
                id="password"
                name="password"
                required
                minlength="6"
                class="w-full px-4 py-3 bg-surface-primary border border-border-default rounded-xl text-content-primary placeholder-content-muted focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent transition-all"
                placeholder="••••••••"
              />
              <p class="text-xs text-content-muted mt-1">Must be at least 6 characters</p>
            </div>

            <div>
              <label for="confirm-password" class="block text-sm font-medium text-content-secondary mb-2">
                Confirm New Password
              </label>
              <input
                type="password"
                id="confirm-password"
                name="confirm-password"
                required
                minlength="6"
                class="w-full px-4 py-3 bg-surface-primary border border-border-default rounded-xl text-content-primary placeholder-content-muted focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent transition-all"
                placeholder="••••••••"
              />
            </div>

            <button
              type="submit"
              id="submit-btn"
              class="w-full py-3 px-4 bg-brand hover:bg-brand-hover text-white font-semibold rounded-xl transition-colors focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-2 focus:ring-offset-surface-card disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Reset Password
            </button>

            <p id="form-error-message" class="text-status-error text-sm text-center hidden"></p>
          </form>
        </div>

        <!-- Success State -->
        <div id="success-container" class="hidden text-center">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-status-success/10 flex items-center justify-center">
            <svg class="w-8 h-8 text-status-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h2 class="text-lg font-semibold text-content-primary mb-2">Password Reset Complete</h2>
          <p class="text-content-secondary text-sm mb-6">
            Your password has been successfully reset. You can now sign in with your new password.
          </p>
          <a
            href="/login"
            class="inline-block px-6 py-2.5 bg-brand text-white font-medium rounded-xl hover:bg-brand-hover transition-colors"
          >
            Sign In
          </a>
        </div>
      </div>
    </div>
    </div>
  </main>
</Layout>

<script>
  import { createSupabaseBrowserClient } from '../lib/supabase';

  const loadingContainer = document.getElementById('loading-container') as HTMLDivElement;
  const errorContainer = document.getElementById('error-container') as HTMLDivElement;
  const formContainer = document.getElementById('form-container') as HTMLDivElement;
  const successContainer = document.getElementById('success-container') as HTMLDivElement;
  const form = document.getElementById('reset-password-form') as HTMLFormElement;
  const formErrorMessage = document.getElementById('form-error-message') as HTMLParagraphElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const errorDetail = document.getElementById('error-detail') as HTMLParagraphElement;

  const supabase = createSupabaseBrowserClient();

  // Check for the recovery token in the URL hash
  async function initPage() {
    // Supabase puts the access_token in the URL hash after email link click
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = hashParams.get('access_token');
    const refreshToken = hashParams.get('refresh_token');
    const type = hashParams.get('type');

    // Also check for error in hash
    const errorCode = hashParams.get('error');
    const errorDescription = hashParams.get('error_description');

    if (errorCode) {
      showError(errorDescription || 'An error occurred');
      return;
    }

    if (type === 'recovery' && accessToken && refreshToken) {
      // Set the session with the tokens from the URL
      const { error } = await supabase.auth.setSession({
        access_token: accessToken,
        refresh_token: refreshToken,
      });

      if (error) {
        showError(error.message);
        return;
      }

      // Clear the hash from URL for security
      window.history.replaceState(null, '', window.location.pathname);

      // Show the form
      showForm();
    } else {
      // Check if we already have a valid session (user refreshed the page)
      const { data: { session } } = await supabase.auth.getSession();

      if (session) {
        showForm();
      } else {
        showError('This password reset link is invalid or has expired. Please request a new one.');
      }
    }
  }

  function showError(message: string) {
    loadingContainer.classList.add('hidden');
    errorDetail.textContent = message;
    errorContainer.classList.remove('hidden');
  }

  function showForm() {
    loadingContainer.classList.add('hidden');
    formContainer.classList.remove('hidden');
  }

  function showSuccess() {
    formContainer.classList.add('hidden');
    successContainer.classList.remove('hidden');
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    formErrorMessage.classList.add('hidden');

    const formData = new FormData(form);
    const password = formData.get('password') as string;
    const confirmPassword = formData.get('confirm-password') as string;

    // Validate passwords match
    if (password !== confirmPassword) {
      formErrorMessage.textContent = 'Passwords do not match';
      formErrorMessage.classList.remove('hidden');
      return;
    }

    // Validate password length
    if (password.length < 6) {
      formErrorMessage.textContent = 'Password must be at least 6 characters';
      formErrorMessage.classList.remove('hidden');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Resetting...';

    const { error } = await supabase.auth.updateUser({
      password: password,
    });

    if (error) {
      formErrorMessage.textContent = error.message;
      formErrorMessage.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Reset Password';
    } else {
      // Sign out after password reset so user can sign in fresh
      await supabase.auth.signOut();
      showSuccess();
    }
  });

  // Initialize the page
  initPage();
</script>
