---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import { createSupabaseServerClient } from '../lib/supabase';
import { getAppName } from '../lib/branding';

const cookieHeader = Astro.request.headers.get('Cookie') ?? '';
const supabase = createSupabaseServerClient(Astro.cookies, cookieHeader);
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

// Get profile
const { data: profile } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', user.id)
  .single();

const appName = getAppName(Astro.url.hostname);
---

<Layout title={`Profile - ${appName}`}>
  <Header user={user} />

  <main class="container mx-auto px-4 py-8 max-w-2xl">
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-content-primary">Profile Settings</h1>
      <p class="text-content-muted mt-1">Manage your account information</p>
    </div>

    <!-- Profile Form -->
    <div class="bg-surface-card rounded-2xl border border-border-default p-6 mb-6">
      <form id="profile-form" class="space-y-6">
        <!-- Avatar Preview -->
        <div class="flex items-center gap-4">
          <div id="avatar-preview" class="w-16 h-16 rounded-full bg-brand flex items-center justify-center text-2xl font-bold text-white overflow-hidden">
            {profile?.avatar_url ? (
              <img src={profile.avatar_url} alt="Avatar" class="w-full h-full object-cover" />
            ) : (
              <span>{(profile?.display_name || user.email)?.charAt(0).toUpperCase()}</span>
            )}
          </div>
          <div>
            <p class="font-medium text-content-primary">{profile?.display_name || 'No display name set'}</p>
            <p class="text-sm text-content-muted">{user.email}</p>
          </div>
        </div>

        <!-- Display Name -->
        <div>
          <label for="display_name" class="block text-sm font-medium text-content-secondary mb-1.5">
            Display Name
          </label>
          <input
            type="text"
            id="display_name"
            name="display_name"
            value={profile?.display_name || ''}
            maxlength="100"
            placeholder="Enter your display name"
            class="w-full px-4 py-2.5 bg-surface-elevated border border-border-default rounded-xl text-content-primary placeholder-content-muted focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
          />
          <p class="text-xs text-content-muted mt-1">This is how you'll appear to other users</p>
        </div>

        <!-- Avatar URL -->
        <div>
          <label for="avatar_url" class="block text-sm font-medium text-content-secondary mb-1.5">
            Avatar URL
          </label>
          <input
            type="text"
            id="avatar_url"
            name="avatar_url"
            value={profile?.avatar_url || ''}
            maxlength="500"
            placeholder="https://example.com/avatar.jpg"
            class="w-full px-4 py-2.5 bg-surface-elevated border border-border-default rounded-xl text-content-primary placeholder-content-muted focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
          />
          <p class="text-xs text-content-muted mt-1">Link to an image for your profile picture</p>
        </div>

        <div id="profile-error" class="hidden text-sm text-status-error bg-status-error/10 px-4 py-2 rounded-lg">
        </div>

        <div id="profile-success" class="hidden text-sm text-status-success bg-status-success/10 px-4 py-2 rounded-lg">
          Profile updated successfully!
        </div>

        <button
          type="submit"
          id="save-btn"
          class="px-6 py-2.5 bg-brand text-white rounded-xl font-medium hover:bg-brand-hover transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Save Changes
        </button>
      </form>
    </div>

    <!-- Account Info -->
    <div class="bg-surface-card rounded-2xl border border-border-default p-6 mb-6">
      <h2 class="text-lg font-semibold text-content-primary mb-4">Account Information</h2>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-content-muted mb-1">Email</label>
          <p class="text-content-primary">{user.email}</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-content-muted mb-1">User ID</label>
          <p class="text-content-secondary text-sm font-mono bg-surface-elevated px-3 py-2 rounded-lg">{user.id}</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-content-muted mb-1">Account Created</label>
          <p class="text-content-primary">{new Date(user.created_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}</p>
        </div>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="bg-surface-card rounded-2xl border border-status-error/30 p-6">
      <h2 class="text-lg font-semibold text-status-error mb-4">Sign Out</h2>
      <p class="text-content-secondary text-sm mb-4">Sign out of your account on this device.</p>
      <form method="POST" action="/api/auth/signout">
        <button
          type="submit"
          class="px-6 py-2.5 bg-status-error text-white rounded-xl font-medium hover:bg-status-error/90 transition-colors"
        >
          Sign Out
        </button>
      </form>
    </div>
  </main>
</Layout>

<script>
  const form = document.getElementById('profile-form') as HTMLFormElement;
  const displayNameInput = document.getElementById('display_name') as HTMLInputElement;
  const avatarUrlInput = document.getElementById('avatar_url') as HTMLInputElement;
  const avatarPreview = document.getElementById('avatar-preview') as HTMLDivElement;
  const errorDiv = document.getElementById('profile-error') as HTMLDivElement;
  const successDiv = document.getElementById('profile-success') as HTMLDivElement;
  const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;

  // Update avatar preview when URL changes
  avatarUrlInput?.addEventListener('input', () => {
    const url = avatarUrlInput.value.trim();
    if (url) {
      avatarPreview.innerHTML = `<img src="${url}" alt="Avatar" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<span class=\\'text-2xl font-bold\\'>${(displayNameInput.value || 'U').charAt(0).toUpperCase()}</span>'" />`;
    } else {
      const initial = (displayNameInput.value || 'U').charAt(0).toUpperCase();
      avatarPreview.innerHTML = `<span class="text-2xl font-bold">${initial}</span>`;
    }
  });

  // Update avatar initial when display name changes
  displayNameInput?.addEventListener('input', () => {
    if (!avatarUrlInput.value.trim()) {
      const initial = (displayNameInput.value || 'U').charAt(0).toUpperCase();
      avatarPreview.innerHTML = `<span class="text-2xl font-bold">${initial}</span>`;
    }
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorDiv.classList.add('hidden');
    successDiv.classList.add('hidden');

    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    try {
      const response = await fetch('/api/profile', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          display_name: displayNameInput.value.trim() || null,
          avatar_url: avatarUrlInput.value.trim() || null,
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to update profile');
      }

      successDiv.classList.remove('hidden');
      setTimeout(() => successDiv.classList.add('hidden'), 3000);
    } catch (err) {
      errorDiv.textContent = err instanceof Error ? err.message : 'Failed to update profile';
      errorDiv.classList.remove('hidden');
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Changes';
    }
  });
</script>
