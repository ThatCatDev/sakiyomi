---
import Layout from '../layouts/Layout.astro';
import { createSupabaseServerClient } from '../lib/supabase';
import { getAppName } from '../lib/branding';

const cookieHeader = Astro.request.headers.get('Cookie') ?? '';
const supabase = createSupabaseServerClient(Astro.cookies, cookieHeader);
const { data: { user } } = await supabase.auth.getUser();

if (user) {
  return Astro.redirect('/');
}

const appName = getAppName(Astro.url.hostname);
---

<Layout title={`Forgot Password - ${appName}`}>
  <main class="min-h-screen flex flex-col p-4">
    <!-- Back link -->
    <div class="max-w-md mx-auto w-full pt-4">
      <a href="/" class="inline-flex items-center gap-2 text-content-secondary hover:text-content-primary transition-colors text-sm">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to home
      </a>
    </div>

    <div class="flex-1 flex items-center justify-center">
    <div class="w-full max-w-md">
      <!-- Logo/Brand -->
      <div class="text-center mb-8">
        <a href="/" class="inline-block">
          <img src="/logo.svg" alt={appName} class="w-16 h-16 mx-auto mb-4" />
          <h1 class="text-2xl font-bold text-content-primary">{appName}</h1>
        </a>
        <p class="text-content-muted mt-2">Reset your password</p>
      </div>

      <!-- Forgot Password Card -->
      <div class="bg-surface-card rounded-2xl shadow-xl p-8 border border-border-default">
        <!-- Initial Form -->
        <div id="request-form-container">
          <p class="text-content-secondary text-sm mb-6">
            Enter your email address and we'll send you a link to reset your password.
          </p>

          <form id="forgot-password-form" method="POST" action="#" class="space-y-6">
            <div>
              <label for="email" class="block text-sm font-medium text-content-secondary mb-2">
                Email address
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-4 py-3 bg-surface-primary border border-border-default rounded-xl text-content-primary placeholder-content-muted focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent transition-all"
                placeholder="you@example.com"
              />
            </div>

            <button
              type="submit"
              id="submit-btn"
              class="w-full py-3 px-4 bg-brand hover:bg-brand-hover text-white font-semibold rounded-xl transition-colors focus:outline-none focus:ring-2 focus:ring-brand focus:ring-offset-2 focus:ring-offset-surface-card disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Send Reset Link
            </button>

            <p id="error-message" class="text-status-error text-sm text-center hidden"></p>
          </form>
        </div>

        <!-- Success Message -->
        <div id="success-container" class="hidden text-center">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-status-success/10 flex items-center justify-center">
            <svg class="w-8 h-8 text-status-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </div>
          <h2 class="text-lg font-semibold text-content-primary mb-2">Check your email</h2>
          <p class="text-content-secondary text-sm mb-4">
            We've sent a password reset link to <strong id="sent-email" class="text-content-primary"></strong>
          </p>
          <p class="text-content-muted text-xs">
            Didn't receive the email? Check your spam folder or
            <button type="button" id="resend-btn" class="text-brand hover:underline">try again</button>
          </p>
        </div>
      </div>

      <!-- Footer -->
      <p class="text-center text-content-muted mt-6">
        Remember your password?
        <a href="/login" class="text-brand hover:text-brand-hover font-medium transition-colors">
          Sign in
        </a>
      </p>
    </div>
    </div>
  </main>
</Layout>

<script>
  import { createSupabaseBrowserClient } from '../lib/supabase';

  const form = document.getElementById('forgot-password-form') as HTMLFormElement;
  const errorMessage = document.getElementById('error-message') as HTMLParagraphElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const requestContainer = document.getElementById('request-form-container') as HTMLDivElement;
  const successContainer = document.getElementById('success-container') as HTMLDivElement;
  const sentEmail = document.getElementById('sent-email') as HTMLElement;
  const resendBtn = document.getElementById('resend-btn') as HTMLButtonElement;
  const emailInput = document.getElementById('email') as HTMLInputElement;

  let lastEmail = '';

  async function sendResetEmail(email: string) {
    const supabase = createSupabaseBrowserClient();

    // Get the current origin for the redirect URL
    const redirectUrl = `${window.location.origin}/reset-password`;

    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: redirectUrl,
    });

    return { error };
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorMessage.classList.add('hidden');

    const formData = new FormData(form);
    const email = formData.get('email') as string;
    lastEmail = email;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';

    const { error } = await sendResetEmail(email);

    if (error) {
      errorMessage.textContent = error.message;
      errorMessage.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Send Reset Link';
    } else {
      sentEmail.textContent = email;
      requestContainer.classList.add('hidden');
      successContainer.classList.remove('hidden');
    }
  });

  resendBtn.addEventListener('click', () => {
    requestContainer.classList.remove('hidden');
    successContainer.classList.add('hidden');
    emailInput.value = lastEmail;
    submitBtn.disabled = false;
    submitBtn.textContent = 'Send Reset Link';
  });
</script>
